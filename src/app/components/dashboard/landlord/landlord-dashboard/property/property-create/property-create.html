<div class="property-create-container">

  <div class="header-section">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="onCancel()" matTooltip="Back to properties">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>{{ isAddUnitMode ? 'Add Units to Property' : 'Create Property' }}</h1>
        <p class="subtitle">{{ isAddUnitMode ? 'Add new units to your existing property' : 'Add a new property and its units to your portfolio' }}</p>
      </div>
    </div>

    <div class="progress-steps" *ngIf="!isAddUnitMode">
      <div class="step" [class.active]="!propertyCreated" [class.completed]="propertyCreated">
        <div class="step-number">1</div>
        <div class="step-label">Property Details</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="propertyCreated" [class.completed]="units.length > 0 && propertyCreated">
        <div class="step-number">2</div>
        <div class="step-label">Add Units</div>
      </div>
    </div>
  </div>

  <div class="form-section" *ngIf="!propertyCreated && !isAddUnitMode">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>home</mat-icon>
          Property Information
        </mat-card-title>
        <mat-card-subtitle>Enter the basic details of your property</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="propertyForm">
          <div class="form-grid">
            <div class="form-field">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Property Name *</mat-label>
                <input matInput formControlName="name" 
                       placeholder="e.g., Sunrise Apartments, Greenview House"
                       maxlength="100">
                <mat-icon matSuffix>home</mat-icon>
                <mat-hint>2-100 characters</mat-hint>
                <mat-error *ngIf="propertyForm.get('name')?.invalid && propertyForm.get('name')?.touched">
                  <span *ngIf="propertyForm.get('name')?.hasError('required')">Property name is required</span>
                  <span *ngIf="propertyForm.get('name')?.hasError('minlength')">Minimum 2 characters required</span>
                  <span *ngIf="propertyForm.get('name')?.hasError('maxlength')">Maximum 100 characters allowed</span>
                  <span *ngIf="propertyForm.get('name')?.hasError('notBlank')">Property name cannot be blank</span>
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-field">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Location *</mat-label>
                <input matInput formControlName="location" 
                       placeholder="e.g., Westlands, Nairobi, Kenya"
                       maxlength="200">
                <mat-icon matSuffix>location_on</mat-icon>
                <mat-hint>Full address or area name</mat-hint>
                <mat-error *ngIf="propertyForm.get('location')?.invalid && propertyForm.get('location')?.touched">
                  <span *ngIf="propertyForm.get('location')?.hasError('required')">Location is required</span>
                  <span *ngIf="propertyForm.get('location')?.hasError('minlength')">Minimum 5 characters required</span>
                  <span *ngIf="propertyForm.get('location')?.hasError('maxlength')">Maximum 200 characters allowed</span>
                  <span *ngIf="propertyForm.get('location')?.hasError('notBlank')">Location cannot be blank</span>
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-field">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Property Type *</mat-label>
                <mat-select formControlName="propertyType">
                  <mat-option *ngFor="let type of propertyTypes" [value]="type.value">
                    {{ type.label }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="propertyForm.get('propertyType')?.invalid && propertyForm.get('propertyType')?.touched">
                  Property type is required
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-field">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Total Units *</mat-label>
                <input matInput type="number" formControlName="totalUnits" 
                       min="1" max="500" placeholder="e.g., 10">
                <mat-icon matSuffix>door_front</mat-icon>
                <mat-hint>Maximum 500 units</mat-hint>
                <mat-error *ngIf="propertyForm.get('totalUnits')?.invalid && propertyForm.get('totalUnits')?.touched">
                  <span *ngIf="propertyForm.get('totalUnits')?.hasError('required')">Total units is required</span>
                  <span *ngIf="propertyForm.get('totalUnits')?.hasError('min')">Minimum 1 unit required</span>
                  <span *ngIf="propertyForm.get('totalUnits')?.hasError('max')">Maximum 500 units allowed</span>
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-field full-width">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Description (Optional)</mat-label>
                <textarea matInput formControlName="description" 
                          placeholder="Brief description of the property, amenities, features..."
                          rows="4" maxlength="1000"></textarea>
                <mat-hint align="end">{{ propertyForm.get('description')?.value?.length || 0 }}/1000</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </form>
      </mat-card-content>

      <mat-card-actions class="form-actions">
        <button mat-stroked-button type="button" (click)="onCancel()" 
                [disabled]="isSubmitting" class="cancel-btn">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>
        <button mat-raised-button color="primary" 
                [disabled]="!propertyForm.valid || isSubmitting"
                (click)="createPropertyWithoutUnits()"
                class="create-btn">
          <span *ngIf="isSubmitting" class="button-spinner">
            <mat-spinner diameter="20"></mat-spinner>
            Creating Property...
          </span>
          <span *ngIf="!isSubmitting">
            <mat-icon>check_circle</mat-icon>
            Create Property & Add Units
          </span>
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <div #unitsSection class="units-section" *ngIf="propertyCreated || isAddUnitMode">
    <mat-card class="property-summary-card" *ngIf="!isAddUnitMode">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>check_circle</mat-icon>
          Property Created Successfully!
        </mat-card-title>
        <mat-card-subtitle>Now add units to {{ propertyForm.get('name')?.value }}</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="property-summary">
          <div class="summary-item">
            <span class="label">Property Name:</span>
            <span class="value">{{ propertyForm.get('name')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Location:</span>
            <span class="value">{{ propertyForm.get('location')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Property Type:</span>
            <span class="value">{{ getPropertyTypeLabel(propertyForm.get('propertyType')?.value) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Total Units Capacity:</span>
            <span class="value">{{ propertyForm.get('totalUnits')?.value }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">
          <mat-icon>door_front</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ units.length }}{{ !isAddUnitMode ? '/' + propertyForm.get('totalUnits')?.value : '' }}</div>
          <div class="stat-label">Units Added</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon revenue">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(monthlyRevenue) }}</div>
          <div class="stat-label">Monthly Revenue</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon deposit">
          <mat-icon>security</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(totalDeposit) }}</div>
          <div class="stat-label">Total Deposits</div>
        </div>
      </div>
      
      <div class="stat-card" *ngIf="!isAddUnitMode">
        <div class="stat-icon remaining">
          <mat-icon>add_circle</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ getRemainingUnits() }}</div>
          <div class="stat-label">Can Add More</div>
        </div>
      </div>
    </div>

    <mat-card class="add-unit-card" *ngIf="isAddUnitMode || !isMaxUnitsReached()">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>add_circle</mat-icon>
          Add New Unit
        </mat-card-title>
        <mat-card-subtitle>Fill in the unit details below</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="unit-form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Unit Number *</mat-label>
            <input matInput [(ngModel)]="newUnit.unitNumber" 
                   placeholder="e.g., A1, 101, G-05" 
                   id="unitNumber"
                   maxlength="20">
            <mat-icon matSuffix>tag</mat-icon>
            <mat-hint>Unique identifier for the unit</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Unit Type *</mat-label>
            <mat-select [(ngModel)]="newUnit.unitType" 
                       (selectionChange)="onUnitTypeChange()">
              <mat-option *ngFor="let type of unitTypes" [value]="type.value">
                {{ type.label }}
              </mat-option>
            </mat-select>
            <mat-hint>Select unit type</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Monthly Rent (KES) *</mat-label>
            <input matInput type="number" [(ngModel)]="newUnit.rentAmount" 
                   min="500" max="1000000"
                   placeholder="25000">
            <span matPrefix>KES&nbsp;</span>
            <mat-hint>Minimum KES 500</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Deposit (KES) *</mat-label>
            <input matInput type="number" [(ngModel)]="newUnit.deposit" 
                   min="0" max="1000000"
                   placeholder="25000">
            <span matPrefix>KES&nbsp;</span>
            <mat-hint>Security deposit amount</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Unit Description (Optional)</mat-label>
            <textarea matInput [(ngModel)]="newUnit.description"
                     placeholder="Brief description of the unit, features, condition..."
                     rows="3" maxlength="500"></textarea>
            <mat-hint align="end">{{ newUnit.description?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>

      <mat-card-actions class="unit-form-actions">
        <button mat-raised-button color="primary" 
                (click)="addUnit()"
                [disabled]="isAddUnitDisabled()"
                class="add-unit-btn">
          <mat-icon>add</mat-icon>
          Add Unit to List
        </button>
        
        <div class="remaining-hint" *ngIf="canAddMoreUnits() && !isAddUnitMode">
          You can add {{ getRemainingUnits() }} more unit{{ getRemainingUnits() !== 1 ? 's' : '' }}
        </div>
      </mat-card-actions>
    </mat-card>

    <div class="units-list-section" *ngIf="units.length > 0">
      <mat-card class="units-list-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>list</mat-icon>
            Added Units ({{ units.length }})
          </mat-card-title>
          <mat-card-subtitle>Review and manage your units before saving</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="units-grid">
            <div *ngFor="let unit of units.controls; let i = index" class="unit-card">
              <div class="unit-header">
                <div class="unit-info">
                  <h4 class="unit-number">
                    <mat-icon>apartment</mat-icon>
                    Unit {{ unit.get('unitNumber')?.value }}
                  </h4>
                  <span class="unit-type">{{ getUnitTypeLabel(unit.get('unitType')?.value) }}</span>
                </div>
                <button mat-icon-button color="warn" 
                        (click)="removeUnit(i)"
                        matTooltip="Remove unit"
                        class="remove-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              
              <div class="unit-details">
                <div class="detail-item">
                  <span class="label">Monthly Rent:</span>
                  <span class="value rent">{{ formatCurrency(unit.get('rentAmount')?.value) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Security Deposit:</span>
                  <span class="value deposit">{{ formatCurrency(unit.get('deposit')?.value) }}</span>
                </div>
                <div class="detail-item" *ngIf="unit.get('description')?.value">
                  <span class="label">Description:</span>
                  <span class="value description">{{ unit.get('description')?.value }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions class="units-list-actions">
          <button mat-stroked-button (click)="onCancel()" class="cancel-units-btn">
            <mat-icon>arrow_back</mat-icon>
            {{ isAddUnitMode ? 'Back to Units' : 'Back to Properties' }}
          </button>
          
          <button mat-raised-button color="primary" 
                  (click)="submitUnits()"
                  [disabled]="isSubmitting || units.length === 0"
                  class="save-units-btn">
            <span *ngIf="isSubmitting" class="button-spinner">
              <mat-spinner diameter="20"></mat-spinner>
              Saving Units...
            </span>
            <span *ngIf="!isSubmitting">
              <mat-icon>save</mat-icon>
              Save All {{ units.length }} Unit{{ units.length !== 1 ? 's' : '' }}
            </span>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <div class="max-units-message" *ngIf="isMaxUnitsReached() && units.length > 0 && !isAddUnitMode">
      <mat-card class="max-units-card">
        <mat-card-content>
          <div class="max-units-content">
            <mat-icon class="success-icon">check_circle</mat-icon>
            <h3>All Units Added Successfully!</h3>
            <p>You've added all {{ propertyForm.get('totalUnits')?.value }} units to {{ propertyForm.get('name')?.value }}.</p>
            <p class="revenue-summary">
              Total Monthly Revenue: <strong>{{ formatCurrency(monthlyRevenue) }}</strong> | 
              Total Deposits: <strong>{{ formatCurrency(totalDeposit) }}</strong>
            </p>
            <button mat-raised-button color="primary" 
                    (click)="submitUnits()"
                    [disabled]="isSubmitting"
                    class="final-save-btn">
              <span *ngIf="isSubmitting" class="button-spinner">
                <mat-spinner diameter="20"></mat-spinner>
                Saving...
              </span>
              <span *ngIf="!isSubmitting">
                <mat-icon>rocket_launch</mat-icon>
                Save & Complete Setup
              </span>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>